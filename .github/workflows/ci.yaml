name: Nerd Font Patcher
permissions: write-all
on:
  workflow_dispatch:
  push:
#    branches:
#      - master
    tags:
      - 'v*'
  #pull_request:
  #  branches:
  #   - master
  # schedule:
  #   - cron: "0 13 * * *"

jobs:
  check-for-new-reddit-sans:
    runs-on: ubuntu-22.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      tag_name: ${{ env.REDDITSANSTAG }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}

    steps:
    - uses: oprypin/find-latest-tag@v1
      with:
        repository: reddit/redditsans  # The repository to scan.
        releases-only: false  # We know that all relevant tags have a GitHub release for them.
      id: find_latest_tag  # The step ID to refer to later.
  
    - run: echo "Reddit Sans Mono is at version ${{ steps.find_latest_tag.outputs.tag }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Save the latest Reddit Sans tag
      run: |
        echo "REDDITSANSTAG=${{ steps.find_latest_tag.outputs.tag }}" >> $GITHUB_ENV
    
    - name: Check if tag exists
      uses: mukunku/tag-exists-action@v1.6.0
      id: check_tag
      with:
        tag: ${{ env.REDDITSANSTAG }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Summary
      run: |
        echo "Latest Reddit Sans tag is $REDDITSANSTAG"

  build-and-release:
    needs: check-for-new-reddit-sans
    if: ${{ github.event_name != 'schedule' || needs.check-for-new-reddit-sans.outputs.tag_exists != 'true' }}
    runs-on: ubuntu-22.04
    env:
      REDDITSANSTAG: ${{ needs.check-for-new-reddit-sans.outputs.tag_name }}
      REDDITSANSTAG_ISNOTNEW: ${{ needs.check-for-new-reddit-sans.outputs.tag_exists }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Decide on version
      run: |
        if [ "${REDDITSANSTAG_ISNOTNEW}" = "false" ]; then
          echo New release is not tagged yet in our repo
          echo It will only be tagged after successfull release in job 'Create tag'
          OURVERSION=${REDDITSANSTAG}
        else
          echo Re-release uses our manual tags and/or patchlevel
          OURVERSION=`git describe --always --tags`
        fi
        echo "OURVERSION=${OURVERSION}" >> $GITHUB_ENV

    - name: Download latest version of Reddit Sans Mono
      # with:
        # tag: ${{ needs.check-for-new-reddit-sans.outputs.tag_name }}
      run: |
        wget https://github.com/reddit/redditsans/raw/refs/heads/main/fonts/mono/ttf/RedditMono-Regular.ttf
        wget https://github.com/reddit/redditsans/raw/refs/heads/main/fonts/mono/ttf/RedditMono-Light.ttf
        wget https://github.com/reddit/redditsans/raw/refs/heads/main/fonts/mono/ttf/RedditMono-Medium.ttf
        wget https://github.com/reddit/redditsans/raw/refs/heads/main/fonts/mono/ttf/RedditMono-SemiBold.ttf
        wget https://github.com/reddit/redditsans/raw/refs/heads/main/fonts/mono/ttf/RedditMono-Bold.ttf
        wget https://github.com/reddit/redditsans/raw/refs/heads/main/fonts/mono/ttf/RedditMono-ExtraBold.ttf
        mv RedditMono-Regular.ttf Reddit-Regular.ttf
        mv RedditMono-Light.ttf Reddit-Light.ttf
        mv RedditMono-Medium.ttf Reddit-Medium.ttf
        mv RedditMono-SemiBold.ttf Reddit-SemiBold.ttf
        mv RedditMono-Bold.ttf Reddit-Bold.ttf
        mv RedditMono-ExtraBold.ttf Reddit-ExtraBold.ttf

    # Ubuntu 20.04 has only fontforge release 2020, but there are some vital bugfixes in the 2022 release
    # This can be replaced with the ordinary apt package when Ubuntu updates, probably with 22.10?
    # On the other hand ... why not be on the latest release always?
    - name: Fetch FontForge
      run: |
        sudo apt install software-properties-common python3-fontforge fuse -y -q
        curl -L "https://github.com/fontforge/fontforge/releases/download/20230101/FontForge-2023-01-01-a1dad3e-x86_64.AppImage" \
          --output fontforge
        chmod u+x fontforge
        echo Try appimage
        ./fontforge --version
        export PATH=`pwd`:$PATH
        echo "PATH=$PATH" >> $GITHUB_ENV
        echo Try appimage with path
        fontforge --version

    - name: Get Font Patcher
      uses: robinraju/release-downloader@v1.10
      with:
        repository: "ryanoasis/nerd-fonts"
        latest: true
        fileName: "FontPatcher.zip"

    - name: Open Font Patcher release
      run: |
        unzip FontPatcher.zip

    - name: Install PIP
      run: sudo apt install python3-pip -y
    
    - name: Install configparser
      run: pip3 install configparser
    
    - name: Extract additional powerline glyphs
      run: fontforge -lang=ff -script "`pwd`/extract-extra-glyphs" "`pwd`" `pwd`/src/glyphs/octicons/octicons.ttf

    - name: Build Powerline Mono # 5th flag, output font name, is irrelevant (no longer used in 'rename-font' script)
      run: |
        ./do_generate 01 --powerline --mono Reddit-Regular.ttf    ReaditSansPL.ttf            "ReaditMono"
        ./do_generate 02 --powerline --mono Reddit-Bold.ttf       ReaditSansPL-Bold.ttf       "ReaditMono"
        ./do_generate 03 --powerline --mono Reddit-SemiBold.ttf   ReaditSansPL-SemiBold.ttf   "ReaditMono"
        ./do_generate 04 --powerline --mono Reddit-ExtraBold.ttf  ReaditSansPL-ExtraBold.ttf  "ReaditMono"
        ./do_generate 05 --powerline --mono Reddit-Light.ttf      ReaditSansPL-Light.ttf      "ReaditMono"
        ./do_generate 06 --powerline --mono Reddit-Medium.ttf     ReaditSansPL-Medium.ttf     "ReaditMono"
       
    - name: Build NF Complete
      run: |
        ./do_generate 07 --complete --no-progressbars Reddit-Regular.ttf    ReaditSans.ttf              "ReaditMono"
        ./do_generate 08 --complete --no-progressbars Reddit-Bold.ttf       ReaditSans-Bold.ttf         "ReaditMono"
        ./do_generate 09 --complete --no-progressbars Reddit-SemiBold.ttf   ReaditSans-SemiBold.ttf     "ReaditMono"
        ./do_generate 10 --complete --no-progressbars Reddit-ExtraBold.ttf  ReaditSans-ExtraBold.ttf    "ReaditMono"
        ./do_generate 11 --complete --no-progressbars Reddit-Light.ttf      ReaditSans-Light.ttf        "ReaditMono"
        ./do_generate 12 --complete --no-progressbars Reddit-Medium.ttf     ReaditSans-Medium.ttf       "ReaditMono"

    - name: Build NF Propo Complete
      run: |
        ./do_generate 07 --variable-width-glyphs --complete Reddit-Regular.ttf    ReaditSans.ttf              "ReaditMono"
        ./do_generate 08 --variable-width-glyphs --complete Reddit-Bold.ttf       ReaditSans-Bold.ttf         "ReaditMono"
        ./do_generate 09 --variable-width-glyphs --complete Reddit-SemiBold.ttf   ReaditSans-SemiBold.ttf     "ReaditMono"
        ./do_generate 10 --variable-width-glyphs --complete Reddit-ExtraBold.ttf  ReaditSans-ExtraBold.ttf    "ReaditMono"
        ./do_generate 11 --variable-width-glyphs --complete Reddit-Light.ttf      ReaditSans-Light.ttf        "ReaditMono"
        ./do_generate 12 --variable-width-glyphs --complete Reddit-Medium.ttf     ReaditSans-Medium.ttf       "ReaditMono"

    - name: Build NF Mono Complete  # 5th flag, output font name, is irrelevant (no longer used in 'rename-font' script)
      run: |
        ./do_generate 01 --mono --complete Reddit-Regular.ttf    ReaditSansPL.ttf            "ReaditMono"
        ./do_generate 02 --mono --complete Reddit-Bold.ttf       ReaditSansPL-Bold.ttf       "ReaditMono"
        ./do_generate 03 --mono --complete Reddit-SemiBold.ttf   ReaditSansPL-SemiBold.ttf   "ReaditMono"
        ./do_generate 04 --mono --complete Reddit-ExtraBold.ttf  ReaditSansPL-ExtraBold.ttf  "ReaditMono"
        ./do_generate 05 --mono --complete Reddit-Light.ttf      ReaditSansPL-Light.ttf      "ReaditMono"
        ./do_generate 06 --mono --complete Reddit-Medium.ttf     ReaditSansPL-Medium.ttf     "ReaditMono"
    #- name: Check for preexisting glyphs
      #run: |
        #grep 'Skipping...' process*.log | grep  -vE ' Powerline(Extra)?Symbols>'

    - name: Upload Powerline Mono Fonts
      uses: actions/upload-artifact@v4
      with:
        name: ReaditMono Powerline
        path: "ReaditMono--powerline.zip"

    - name: Upload NF Complete Fonts
      uses: actions/upload-artifact@v4
      with:
        name: ReaditMono NF Complete
        path: "ReaditMono--complete.zip"

    - name: Upload NF Propo Fonts
      uses: actions/upload-artifact@v4
      with:
        name: ReaditMono NF Propo Complete
        path: "ReaditMono--variable-width-glyphs.zip"

    - name: Upload NF Mono Complete Fonts
      uses: actions/upload-artifact@v4
      with:
        name: ReaditMono NF Mono Complete
        path: "ReaditMono--mono.zip"
    # Release part
    - name: Create tag
      if: ${{ github.event_name != 'pull_request' && !startsWith(github.ref, 'refs/tags/') && needs.check-for-new-reddit-sans.outputs.tag_exists != 'true' }}
      uses: EndBug/latest-tag@latest
      with:
        ref: ${{ needs.check-for-new-reddit-sans.outputs.tag_name }}
        description: "Bump Readit Sans version to ${{ needs.check-for-new-reddit-sans.outputs.tag_name }}"

    - name: Get tag name
      id: get_tag_name
      if: ${{ startsWith(github.ref, 'refs/tags/') }}
      uses: battila7/get-version-action@v2

    - name: Release
      uses: softprops/action-gh-release@v2
      if: ${{ github.event_name != 'pull_request' && (startsWith(github.ref, 'refs/tags/') || needs.check-for-new-reddit-sans.outputs.tag_exists != 'true') }}
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && steps.get_tag_name.outputs.version || needs.check-for-new-reddit-sans.outputs.tag_name }}
        files: |
          ReaditMono--powerline.zip
          ReaditMono--complete.zip
          ReaditMono--variable-width-glyphs.zip
          ReaditMono--mono.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
